project:
  type: book
  output-dir: _book

# Enable \( \) and \[ \] math delimiters
from: markdown+tex_math_single_backslash

# Don't re-execute code in CI - use frozen results
execute:
  freeze: true

# Use pre-compiled mermaid SVGs in CI
filters:
  - mermaid-static
  - theorem-numbering
  - resolve-crossrefs

book:
  title: "Linear Algebra"
  subtitle: "Proof-based Introduction"
  author: "Tzu-You Lin"
  date: last-modified
  downloads: [pdf]
  # AUTO-GENERATED CHAPTERS - Do not edit manually
  # Run 'make update' to regenerate from src/ directory
  chapters:
    - index.qmd

    - part: src/ch00-foundations/index.qmd
      chapters:
        - src/ch00-foundations/01-sets-and-notation.qmd
        - src/ch00-foundations/02-functions.qmd
        - src/ch00-foundations/03-polynomials.qmd
        - src/ch00-foundations/04-fields.qmd
        - src/ch00-foundations/05-matrices.qmd

    - part: src/ch01-vector-spaces/index.qmd
      chapters:
        - src/ch01-vector-spaces/01-vector-spaces.qmd
        - src/ch01-vector-spaces/02-subspaces.qmd
        - src/ch01-vector-spaces/03-span.qmd
        - src/ch01-vector-spaces/04-independence.qmd
        - src/ch01-vector-spaces/05-basis.qmd
        - src/ch01-vector-spaces/06-dimension.qmd

format:
  html:
    theme: cosmo
    toc: true
    number-sections: true
    code-tools: false
    html-math-method: mathjax
    css: config/html-styles.css
    include-after-body:
      text: |
        <script>
        document.addEventListener('DOMContentLoaded', function() {
          // ==========================================
          // 0. Fix sidebar/TOC numbering to chapter.section format
          // ==========================================
          // Fix part (chapter) titles: "Preliminary" -> "0 Preliminary"
          document.querySelectorAll('.sidebar-item-section .sidebar-item-text').forEach(function(item) {
            var link = item.closest('a');
            if (!link) return;
            var href = link.getAttribute('href') || '';
            var match = href.match(/ch(\d+)-[^\/]+\/index\.html/);
            if (match) {
              var chNum = parseInt(match[1], 10);
              // Remove ALL leading numbers/whitespace and add correct chapter number
              var text = item.textContent.replace(/^[\d\.\s]+/, '').trim();
              item.textContent = chNum + ' ' + text;
            }
          });
          
          // Fix section titles: "1 Sets and Notation" -> "0.1 Sets and Notation"
          document.querySelectorAll('.sidebar-item .sidebar-item-text').forEach(function(item) {
            var link = item.closest('a');
            if (!link) return;
            var href = link.getAttribute('href') || '';
            var match = href.match(/ch(\d+)-[^\/]+\/(\d+)-[^\/]+\.html/);
            if (match) {
              var chNum = parseInt(match[1], 10);
              var secNum = parseInt(match[2], 10);
              // Remove ALL leading numbers/whitespace and add correct section number
              var text = item.textContent.replace(/^[\d\.\s]+/, '').trim();
              item.textContent = chNum + '.' + secNum + ' ' + text;
            }
          });
          
          // Also fix the page title/breadcrumb section numbers
          var pageTitle = document.querySelector('.content h1.title .chapter-number, .content h1 .chapter-number');
          if (pageTitle) {
            var pathMatch = window.location.pathname.match(/ch(\d+)-[^\/]+\/(\d+)-/);
            if (pathMatch) {
              pageTitle.textContent = parseInt(pathMatch[1], 10) + '.' + parseInt(pathMatch[2], 10);
            }
          }
          
          // Fix prev/next navigation arrows at bottom of page
          document.querySelectorAll('.nav-page-next .nav-page-text, .nav-page-previous .nav-page-text').forEach(function(navText) {
            var link = navText.closest('a');
            if (!link) return;
            var href = link.getAttribute('href') || '';
            var match = href.match(/ch(\d+)-[^\/]+\/(\d+)-[^\/]+\.html/);
            if (match) {
              var chNum = parseInt(match[1], 10);
              var secNum = parseInt(match[2], 10);
              // Remove old number and add correct chapter.section number
              var text = navText.textContent.replace(/^[\d\.\s]+/, '').trim();
              navText.textContent = chNum + '.' + secNum + ' ' + text;
            }
          });
          
          // ==========================================
          // 1. Add PDF download link to right TOC sidebar
          // ==========================================
          var path = window.location.pathname;
          
          if (!path.endsWith('/') && !path.endsWith('/index.html') && path !== '/index.html') {
            var pdfPath = path.replace(/\.html$/, '.pdf');
            var section = document.createElement('div');
            section.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;';
            section.innerHTML = 
              '<h6 style="font-size:0.875rem;font-weight:600;margin-bottom:0.5rem;">Other Formats</h6>' +
              '<a href="' + pdfPath + '" style="display:flex;align-items:center;gap:0.5rem;color:inherit;text-decoration:none;font-size:0.875rem;">' +
              '<i class="bi bi-file-pdf" style="color:#dc3545;"></i> PDF</a>';
            
            var tocSidebar = document.querySelector('#quarto-margin-sidebar') ||
                             document.querySelector('.toc-active') ||
                             document.querySelector('#TOC');
            if (tocSidebar) {
              tocSidebar.appendChild(section);
            }
          }
          
          // ==========================================
          // 2. Fix theorem numbering to chapter.section.counter format
          // ==========================================
          // Extract chapter and section from path: /src/chXX-.../YY-name.html
          var pathMatch = path.match(/ch(\d+)-[^\/]+\/(\d+)-/);
          if (pathMatch) {
            var chapterNum = parseInt(pathMatch[1], 10);
            var sectionNum = parseInt(pathMatch[2], 10);
            
            // Separate counters for each type
            var counters = {
              'thm': 0, 'lem': 0, 'cor': 0, 'prp': 0, 
              'def': 0, 'exr': 0, 'alg': 0
            };
            
            // Define types
            var numberedTypes = Object.keys(counters);
            var unnumberedTypes = ['exm', 'cnj'];
            
            var allTypes = numberedTypes.concat(unnumberedTypes);
            var selector = allTypes.map(function(t) { return '[id^="' + t + '-"]'; }).join(', ');
            var theoremDivs = document.querySelectorAll(selector);
            
            theoremDivs.forEach(function(div) {
              var id = div.getAttribute('id') || '';
              var type = id.split('-')[0];
              
              if (unnumberedTypes.includes(type)) {
                // UNNUMBERED: Remove numbers from title/header
                
                // 1. Update theorem-title strong: "Example 1.2.1" -> "Example"
                var titleStrong = div.querySelector('.theorem-title strong');
                if (titleStrong) {
                  // Keep only the text part (e.g. "Example")
                  titleStrong.innerHTML = titleStrong.innerHTML.replace(/\s+\d+(\.\d+)*/, '');
                }
                
                // 2. Update definition-title if present
                var defTitle = div.querySelector('.definition-title');
                if (defTitle) {
                  defTitle.innerHTML = defTitle.innerHTML.replace(/\s+\d+(\.\d+)*/, '');
                }
                
                // 3. Clear data-number
                div.querySelectorAll('[data-number]').forEach(function(el) {
                  el.removeAttribute('data-number');
                });
                
                // 4. Clear header sections
                div.querySelectorAll('.header-section-number').forEach(function(el) {
                  el.textContent = '';
                });
                
              } else if (counters.hasOwnProperty(type)) {
                // NUMBERED: Apply separate counters
                counters[type]++;
                var newNumber = chapterNum + '.' + sectionNum + '.' + counters[type];
                
                // Update the theorem-title strong element
                var titleStrong = div.querySelector('.theorem-title strong');
                if (titleStrong) {
                  titleStrong.innerHTML = titleStrong.innerHTML.replace(/\d+(\.\d+)+/, newNumber);
                }
                
                // Also update definition-title if present
                var defTitle = div.querySelector('.definition-title');
                if (defTitle) {
                  defTitle.innerHTML = defTitle.innerHTML.replace(/\d+(\.\d+)+/, newNumber);
                }
                
                // Update data-number attributes
                var numbered = div.querySelectorAll('[data-number]');
                numbered.forEach(function(el) {
                  el.setAttribute('data-number', newNumber);
                });
                
                // Update figcaption text
                var caption = div.querySelector('figcaption');
                if (caption) {
                  caption.innerHTML = caption.innerHTML.replace(/\d+(\.\d+)+/, newNumber);
                }
                
                // Update headings
                var headings = div.querySelectorAll('h2, h3, h4, h5, h6');
                headings.forEach(function(h) {
                  var numSpan = h.querySelector('.header-section-number');
                  if (numSpan) {
                    numSpan.textContent = newNumber;
                  }
                  if (h.hasAttribute('data-number')) {
                    h.setAttribute('data-number', newNumber);
                  }
                });
              }
            });
          }
          
          // ==========================================
          // 3. Fix ALL cross-references using global theorem map
          // ==========================================
          var globalTheoremMap = null;
          
          fetch('/theorem-map.json')
            .then(function(response) { return response.json(); })
            .then(function(theoremMap) {
              globalTheoremMap = theoremMap;
              
              // Find all cross-reference links to theorem-like elements
              var refLinks = document.querySelectorAll('a[href*="def-"], a[href*="thm-"], a[href*="lem-"], a[href*="cor-"], a[href*="prp-"], a[href*="exm-"], a[href*="exr-"], a[href*="cnj-"], a[href*="alg-"]');
              refLinks.forEach(function(link) {
                var href = link.getAttribute('href');
                // Extract the ID from href (could be #id or path#id)
                var hashIndex = href.indexOf('#');
                if (hashIndex !== -1) {
                  var targetId = href.substring(hashIndex + 1);
                  if (theoremMap[targetId]) {
                    // Replace the number in the link text
                    link.innerHTML = link.innerHTML.replace(/\d+\.\d+/, theoremMap[targetId]);
                  }
                }
              });
              
              // ==========================================
              // 4. Fix tooltip (hover preview) numbering
              // ==========================================
              // (Moved to global scope below to handle outside of fetch and with safety checks)
              
            })
            .catch(function(err) {
              console.log('Could not load theorem map:', err);
              // Still run observer even if map fails (though logic is now duplicated/moved, 
              // better to just fail map and rely on global observer if we moved it out.
              // Actually, wait, I can just copy the observer code out or leave it here?
              // The instructions said "Move it OUT". So I should close the fetch chain EARLIER.
            });
          
          // MOVED OUTSIDE FETCH:
          // Use MutationObserver for robust tooltip handling
          
          // Track modal state
          var isModalOpen = false;
          
          // Bootstrap 5 modal events
          document.addEventListener('show.bs.modal', function () { isModalOpen = true; });
          document.addEventListener('hidden.bs.modal', function () { isModalOpen = false; });
          
          var observer = new MutationObserver(function(mutations) {
             // Optimization: Don't run if a modal is open (prevents freezing code-tools)
             if (isModalOpen || document.body.classList.contains('modal-open') || document.querySelector('.modal-backdrop')) return;
             
             mutations.forEach(function(mutation) {
               mutation.addedNodes.forEach(function(node) {
                 if (node.nodeType === Node.ELEMENT_NODE) {
                   // Targeted check: is this a tippy tooltip or does it contain one?
                   if (node.classList && node.classList.contains('tippy-box')) {
                     var tc = node.querySelector('.tippy-content');
                     if (tc) fixTooltipContent(tc);
                   } else if (node.classList && node.classList.contains('tippy-content')) {
                     fixTooltipContent(node);
                   } else if (node.querySelectorAll) {
                     // Only query if the node is a likely container for tooltips
                     // This avoids scanning massive blocks of code/text
                     if (node.classList && (node.classList.contains('tippy-box') || node.id === 'quarto-ref-popover')) {
                       node.querySelectorAll('.tippy-content').forEach(function(tc) { fixTooltipContent(tc); });
                     }
                   }
                 }
               });
             });
          });
          observer.observe(document.body, { childList: true, subtree: true });
            
          // Fallback - Pause during modals
          setInterval(function() {
             if (isModalOpen || document.body.classList.contains('modal-open') || document.querySelector('.modal-backdrop')) return;
             
             document.querySelectorAll('.tippy-content:not([data-numbering-fixed])').forEach(function(tc) { 
               fixTooltipContent(tc); 
             });
          }, 500);

          // Function to fix numbering in tooltip content
          function fixTooltipContent(tooltipContent) {
            if (!tooltipContent || tooltipContent.dataset.numberingFixed) return;
            
            // Mark as fixed BEFORE modifying to prevent infinite mutation loops
            tooltipContent.dataset.numberingFixed = 'true'; 
            
            // Find theorem-title elements in tooltip
            var titles = tooltipContent.querySelectorAll('.theorem-title strong, .theorem-title');
            titles.forEach(function(title) {
              // Just strip the number entirely: "Theorem 9.1 (Name)" -> "Theorem (Name)"
              // Regex matches space + number pattern (e.g. " 9.1", " 1.2.3")
              var originalHTML = title.innerHTML;
              var newHTML = originalHTML.replace(/\s+\d+(\.\d+)*/, '');
              if (newHTML !== originalHTML) {
                title.innerHTML = newHTML;
              }
            });
          }
        });
        </script>
    
  pdf:
    documentclass: extbook
    classoption: [13.5pt, a4paper, oneside, openany]
    number-sections: true
    colorlinks: true
    linkcolor: "blue"
    urlcolor: "blue"
    pdf-engine: lualatex
    linestretch: 1.1
    fig-width: 6
    fig-pos: "H"
    include-in-header:
      - text: |
          \usepackage[quartoenv]{./config/latex-template}
          % Strip numbers from unnumbered theorem environments
          \directlua{require("config/strip-numbers")}
          % Suppress title page
          \AtBeginDocument{\let\maketitle\relax}
          % List spacing (1.3x)
          \usepackage{enumitem}
          \setlist{itemsep=1.2em, parsep=0pt}
          % Custom enumeration with prefix: \begin{customenum}{VS} gives VS1, VS2, ...
          \newlist{customenum}{enumerate}{1}
          \setlist[customenum,1]{label=\customenumprefix\arabic*, itemsep=1.2em}
          \newcommand{\customenumprefix}{}
          \usepackage[bookmode]{./config/chapter-style}
    geometry:
      - margin=1.2in
